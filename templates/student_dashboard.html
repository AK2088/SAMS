{% extends 'base.html' %}
{% block title %}Student Dashboard{% endblock %}
{% block extra_css %}
<style>
    @media (max-width: 576px) {
        .dashboard-top-actions {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: stretch;
        }

        .dashboard-top-actions .btn {
            width: 100%;
            margin: 0;
        }

        .dashboard-top-actions #clock {
            text-align: left;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
    <div class="container py-4">

        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
            <div>
                <h4 class="fw-semibold mb-1">Welcome, {{name}}</h4>
                <p class="text-muted mb-0">Here are your classes scheduled for today</p>
            </div>

            <div class="text-end dashboard-top-actions">
                <div id="clock" class="fw-semibold"></div>
                <button id="faceRegisterBtn" class="btn {% if face_verified %}btn-success{% else %}btn-primary{% endif %} btn-sm mt-1 me-2">
                    {% if face_verified %}Face Verified{% else %}Register Facial Biometrics{% endif %}
                </button>
                <a href="{%  url 'logout' %}" class="btn btn-outline-danger btn-sm mt-1">
                    Logout
                </a>
            </div>
        </div>

        <div class="row g-3">
            {% for cls in classes %}
            <div class="col-12 col-sm-6 col-lg-4">
                <div class="card h-100 p-3 d-flex flex-column">
                    <div class="mb-2">
                        <h6 class="fw-semibold mb-1">{{ cls.subject_name }}</h6>
                        <small class="text-muted">{{ cls.section_code }} | {{ cls.teacher_name }}</small>
                    </div>

                    <div class="mb-2">
                        <span class="badge bg-light text-dark border">
                            {% if cls.start_time and cls.end_time %}
                                {{ cls.start_time|time:"h:i A" }} - {{ cls.end_time|time:"h:i A" }}
                            {% else %}
                                Timing Not Set
                            {% endif %}
                        </span>
                    </div>
                    <div class="mb-3">
                        <span class="badge bg-{{ cls.status_color }}">{{ cls.status_text }}</span>
                    </div>

                    <div class="mt-auto">
                        <button class="btn btn-primary btn-sm w-100" data-classroom-id="{{ cls.id }}" {% if not face_verified %}disabled{% endif %}>
                            {% if face_verified %} Mark Attendance {% else %} Register Biometrics First {% endif %}
                        </button>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12">
                {% if section_code %}
                <div class="alert alert-info mb-0">No classes configured for your section ({{ section_code }}) yet.</div>
                {% else %}
                <div class="alert alert-warning mb-0">You are not mapped to any section yet. Contact admin.</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cameraModalLabel">Register Facial Biometrics</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <video id="video" autoplay playsinline style="width: 100%; max-width: 500px; border-radius: 8px;"></video>
                <canvas id="canvas" style="display: none;"></canvas>
                <div id="cameraStatus" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="captureBtn">Capture Photo</button>
            </div>
        </div>
    </div>
</div>

<script>
    function updateClock() {
        const now = new Date();
        const options = {
            weekday: 'short',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        };
        document.getElementById('clock').innerText = now.toLocaleString('en-IN', options);
    }
    setInterval(updateClock, 1000);
    updateClock();
</script>

<script>
    function initFaceRegistration() {
        let stream = null;
        const faceVerified = {{ face_verified|yesno:"true,false" }};
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('captureBtn');
        const faceRegisterBtn = document.getElementById('faceRegisterBtn');
        const cameraStatus = document.getElementById('cameraStatus');
        const cameraModalElement = document.getElementById('cameraModal');

        if (!faceRegisterBtn || !cameraModalElement) {
            return;
        }

        let cameraModal = null;
        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            cameraModal = new bootstrap.Modal(cameraModalElement);
        }

        faceRegisterBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (faceVerified) {
                alert('Your face is already verified!');
                return;
            }
            if (!cameraModal && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                cameraModal = new bootstrap.Modal(cameraModalElement);
            }
            if (cameraModal) {
                cameraModal.show();
                setTimeout(function() {
                    startCamera();
                }, 300);
            }
        });

        function startCamera() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                cameraStatus.innerHTML = '<span class="text-danger">Camera API not supported in this browser.</span>';
                return;
            }
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
                .then(function(mediaStream) {
                    stream = mediaStream;
                    video.srcObject = stream;
                    cameraStatus.innerHTML = '<span class="text-success">Camera ready. Position your face in the frame.</span>';
                })
                .catch(function() {
                    cameraStatus.innerHTML = '<span class="text-danger">Error accessing camera. Please allow camera permissions.</span>';
                });
        }

        cameraModalElement.addEventListener('hidden.bs.modal', function() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            if (video) {
                video.srcObject = null;
            }
            if (cameraStatus) {
                cameraStatus.innerHTML = '';
            }
        });

        if (captureBtn) {
            captureBtn.addEventListener('click', function() {
                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0);
                const imageData = canvas.toDataURL('image/png');
                captureBtn.disabled = true;
                captureBtn.textContent = 'Processing...';
                cameraStatus.innerHTML = '<div class="alert alert-info"><strong>Processing your face...</strong><br><small>This might take a minute. Please wait...</small></div>';
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');

                fetch('{% url "registerFace" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ image: imageData })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        cameraStatus.innerHTML = '<span class="text-success">Face registered successfully!</span>';
                        faceRegisterBtn.textContent = 'Face Verified';
                        faceRegisterBtn.classList.remove('btn-primary');
                        faceRegisterBtn.classList.add('btn-success');
                        setTimeout(() => {
                            if (cameraModal) {
                                cameraModal.hide();
                            }
                            location.reload();
                        }, 1500);
                    } else {
                        cameraStatus.innerHTML = '<span class="text-danger">' + (data.error || 'Error registering face') + '</span>';
                        captureBtn.disabled = false;
                        captureBtn.textContent = 'Capture Photo';
                    }
                })
                .catch(function() {
                    cameraStatus.innerHTML = '<span class="text-danger">Error sending data to server.</span>';
                    captureBtn.disabled = false;
                    captureBtn.textContent = 'Capture Photo';
                });
            });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initFaceRegistration);
    } else {
        if (typeof bootstrap !== 'undefined') {
            initFaceRegistration();
        } else {
            window.addEventListener('load', function() {
                setTimeout(initFaceRegistration, 100);
            });
        }
    }
</script>

{% endblock %}
